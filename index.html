<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame AR Model Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <!-- AR.js for webcam AR and pattern recognition -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- A-Frame extras for animations -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <!-- Post-processing for bloom/glow effect -->
    <script src="https://unpkg.com/aframe-postprocessing-component/dist/aframe-postprocessing-component.min.js"></script>
    
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      .ar-instructions {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 999;
        text-align: center;
        transition: opacity 0.5s;
      }
      #no-ar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #111122;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        text-align: center;
        padding: 20px;
      }
      #no-ar.hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="no-ar">
      <h2>AR Experience Loading</h2>
      <p>Please allow camera access when prompted.</p>
      <p>If nothing happens, your device might not support WebAR.</p>
    </div>
    
    <div class="ar-instructions">
      Point camera at the JUP pattern marker
    </div>

    <!-- A-Frame Scene with AR.js -->
    <a-scene 
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; patternRatio: 0.75;"
      embedded
      renderer="logarithmicDepthBuffer: true; colorManagement: true; gammaOutput: true;"
      vr-mode-ui="enabled: false">
      
      <!-- Assets Management -->
      <a-assets>
        <a-asset-item id="model-obj" src="jupdroplight.obj"></a-asset-item>
        <a-asset-item id="model-mtl" src="jupdroplight.mtl"></a-asset-item>
      </a-assets>

      <!-- Camera -->
      <a-entity camera></a-entity>
      
      <!-- Pattern Marker -->
      <a-marker type="pattern" url="jup.patt" emitevents="true" id="jup-marker">
        <!-- Model with animations and glow effect -->
        <a-entity
          id="model"
          obj-model="obj: #model-obj; mtl: #model-mtl"
          position="0 0.5 0"
          scale="1 1 1"
          material="emissive: #66ccff; emissiveIntensity: 0.9"
          animation="property: rotation; to: 0 360 0; dur: 10000; easing: linear; loop: true"
          animation__tilt="property: rotation; from: -10 0 -5; to: 10 0 5; dir: alternate; dur: 2000; easing: easeInOutQuad; loop: true">
        </a-entity>
        
        <!-- Bloom effect light -->
        <a-entity 
          light="type: point; color: #66ccff; intensity: 2; distance: 3"
          position="0 1 0">
        </a-entity>
      </a-marker>
    </a-scene>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Hide loading screen once AR scene is ready
        const scene = document.querySelector('a-scene');
        const noArDiv = document.getElementById('no-ar');
        
        scene.addEventListener('loaded', function() {
          setTimeout(function() {
            noArDiv.classList.add('hidden');
          }, 1000);
        });

        // Handle marker detection
        const marker = document.getElementById('jup-marker');
        const instructions = document.querySelector('.ar-instructions');
        
        marker.addEventListener('markerFound', function() {
          // Hide instructions when marker is found
          instructions.style.opacity = '0';
        });
        
        marker.addEventListener('markerLost', function() {
          // Show instructions when marker is lost
          instructions.style.opacity = '1';
        });
        
        // Add device orientation event to adjust model for device rotation
        window.addEventListener('deviceorientation', function(event) {
          const model = document.getElementById('model');
          if (model && event.beta) {
            // Limit the tilt based on device orientation
            const tiltY = Math.min(Math.max(event.beta - 45, -20), 20);
            // Apply subtle tilt to the model based on device orientation
            const currentAnimation = model.getAttribute('animation__tilt');
            if (currentAnimation) {
              model.setAttribute('animation__tilt', 
                `property: rotation; from: ${-10 + tiltY / 2} 0 -5; to: ${10 + tiltY / 2} 0 5; dir: alternate; dur: 2000; easing: easeInOutQuad; loop: true`);
            }
          }
        });
      });
    </script>
  </body>
</html>
