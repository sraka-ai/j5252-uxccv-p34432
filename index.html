<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame AR Model Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <!-- AR.js for webcam AR and pattern recognition -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- A-Frame extras for animations -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <!-- A-Frame OBJ loader component -->
    <script src="https://unpkg.com/aframe-extras@3.13.1/dist/aframe-extras.loaders.min.js"></script>
    
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      .ar-instructions {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 999;
        text-align: center;
        transition: opacity 0.5s;
      }
      #no-ar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #111122;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        text-align: center;
        padding: 20px;
      }
      #no-ar.hidden {
        display: none;
      }
      .debug-info {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 999;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="no-ar">
      <h2>AR Experience Loading</h2>
      <p>Please allow camera access when prompted.</p>
      <p>If nothing happens, your device might not support WebAR.</p>
    </div>
    
    <div class="ar-instructions">
      Point camera at the JUP pattern marker
    </div>
    
    <div class="debug-info" id="debug-info">
      Model status: Waiting for marker
    </div>

    <!-- A-Frame Scene with AR.js -->
    <a-scene 
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; patternRatio: 0.75;"
      embedded
      renderer="logarithmicDepthBuffer: true; colorManagement: true; gammaOutput: true;">
      
      <!-- Assets Management -->
      <a-assets timeout="10000">
        <a-asset-item id="model-obj" src="jupdroplight.obj"></a-asset-item>
        <a-asset-item id="model-mtl" src="jupdroplight.mtl"></a-asset-item>
      </a-assets>

      <!-- Camera -->
      <a-entity camera></a-entity>
      
      <!-- Pattern Marker -->
      <a-marker type="pattern" url="jup.patt" emitevents="true" id="jup-marker">
        <!-- Container for better positioning -->
        <a-entity position="0 1.5 0">
          <!-- Model with animations and glow effect -->
          <a-entity
            id="model"
            obj-model="obj: #model-obj; mtl: #model-mtl"
            material="shader: standard; color: #fff; emissive: #66ccff; emissiveIntensity: 0.9;"
            position="0 0 0"
            scale="1 1 1"
            animation="property: rotation; to: 0 360 0; dur: 10000; easing: linear; loop: true"
            animation__tilt="property: rotation; from: -10 0 -5; to: 10 0 5; dir: alternate; dur: 2000; easing: easeInOutQuad; loop: true">
          </a-entity>
          
          <!-- Bloom effect light -->
          <a-entity 
            light="type: point; color: #66ccff; intensity: 2; distance: 3"
            position="0 0.5 0">
          </a-entity>
        </a-entity>
      </a-marker>
    </a-scene>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Hide loading screen once AR scene is ready
        const scene = document.querySelector('a-scene');
        const noArDiv = document.getElementById('no-ar');
        const debugInfo = document.getElementById('debug-info');
        
        // For debugging in development
        // debugInfo.style.display = 'block';
        
        scene.addEventListener('loaded', function() {
          setTimeout(function() {
            noArDiv.classList.add('hidden');
            debugInfo.textContent = "Scene loaded, waiting for marker";
          }, 1000);
        });

        // Check if assets are loaded
        const model = document.getElementById('model');
        if (model) {
          model.addEventListener('model-loaded', function(e) {
            debugInfo.textContent = "Model loaded successfully";
            
            // Force material update to ensure textures are applied
            setTimeout(function() {
              const mesh = model.getObject3D('mesh');
              if (mesh) {
                mesh.traverse(function(node) {
                  if (node.isMesh) {
                    node.material.needsUpdate = true;
                  }
                });
              }
            }, 500);
          });
          
          model.addEventListener('model-error', function(e) {
            debugInfo.textContent = "Error loading model: " + e.detail.message;
          });
        }

        // Handle marker detection
        const marker = document.getElementById('jup-marker');
        const instructions = document.querySelector('.ar-instructions');
        
        marker.addEventListener('markerFound', function() {
          // Hide instructions when marker is found
          instructions.style.opacity = '0';
          debugInfo.textContent = "Marker found, displaying model";
        });
        
        marker.addEventListener('markerLost', function() {
          // Show instructions when marker is lost
          instructions.style.opacity = '1';
          debugInfo.textContent = "Marker lost, find marker again";
        });
        
        // Add device orientation event to adjust model for device rotation
        window.addEventListener('deviceorientation', function(event) {
          if (model && event.beta) {
            // Limit the tilt based on device orientation
            const tiltY = Math.min(Math.max(event.beta - 45, -20), 20);
            // Apply subtle tilt to the model based on device orientation
            const currentAnimation = model.getAttribute('animation__tilt');
            if (currentAnimation) {
              model.setAttribute('animation__tilt', 
                `property: rotation; from: ${-10 + tiltY / 2} 0 -5; to: ${10 + tiltY / 2} 0 5; dir: alternate; dur: 2000; easing: easeInOutQuad; loop: true`);
            }
          }
        });
      });
    </script>
  </body>
</html>
